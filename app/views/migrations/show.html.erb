<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
  <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet">
  <title>Migration <%= @migration.token %> - <%= EuroskyConfig::SITE_NAME %></title>
  <% if EuroskyConfig::FAVICON_URL.present? %>
    <link rel="icon" type="image/png" href="<%= EuroskyConfig::FAVICON_URL %>">
  <% end %>
  <% unless @migration.completed? || @migration.failed? %>
    <meta http-equiv="refresh" content="10">
  <% end %>
  <%= render 'shared/styles' %>
  <style>
    /* Page-specific styles for show.html.erb */
    .page-layout {
      display: flex;
      justify-content: center;
      max-width: 1020px;
      margin: 0 auto;
    }

    .page-layout.has-sidebar {
      display: grid;
      grid-template-columns: minmax(0, 700px) 280px;
      grid-template-rows: auto 1fr;
      justify-content: center;
    }

    .container {
      max-width: 700px;
    }

    .has-sidebar .container {
      grid-column: 1;
      grid-row: 1 / -1;
      display: grid;
      grid-template-rows: subgrid;
      max-width: none;
    }

    .backup-sidebar {
      grid-column: 2;
      grid-row: 2;
      align-self: start;
      position: sticky;
      top: 20px;
    }

    .backup-sidebar-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      border-left: 4px solid #10b981;
    }

    .backup-sidebar-card.backup-urgent {
      border-left-color: #3b82f6;
      animation: pulse-border 2s ease-in-out infinite;
    }

    @keyframes pulse-border {
      0%, 100% { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
      50% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.25); }
    }

    .backup-sidebar-header {
      background: #d1fae5;
      padding: 16px;
      font-weight: 700;
      font-size: 15px;
      color: #065f46;
    }

    .backup-urgent .backup-sidebar-header {
      background: #dbeafe;
      color: #1e40af;
    }

    .backup-sidebar-body {
      padding: 16px;
    }

    .backup-sidebar-body p {
      font-size: 13px;
      color: #374151;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .backup-sidebar-body .backup-meta {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .backup-sidebar-body .backup-meta strong {
      color: #374151;
    }

    .backup-sidebar-body .backup-download-btn {
      display: block;
      text-align: center;
      padding: 12px 16px;
      background: var(--gradient);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .backup-sidebar-body .backup-download-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .token {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 2px;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 6px;
      display: inline-block;
      margin-top: 8px;
    }

    .bookmark-notice {
      background: #e0f2fe;
      border-left: 4px solid #0284c7;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 4px;
    }

    .bookmark-notice h3 {
      color: #075985;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .bookmark-notice p {
      color: #075985;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .bookmark-notice code {
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: "SF Mono", Monaco, "Courier New", monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .progress-section {
      margin-bottom: 30px;
    }

    .progress-bar-container {
      background: #e5e7eb;
      height: 30px;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      background: var(--gradient);
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      transition: width 0.3s ease;
    }

    .status-info, .metrics-grid {
      margin-bottom: 24px;
    }

    .status-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .status-value {
      font-size: 18px;
      font-weight: 600;
    }

    .status-completed { color: #10b981; }
    .status-failed { color: #dc2626; }
    .status-in-progress { color: #3b82f6; }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .metric-card {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .metric-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
    }

    @media (max-width: 1060px) {
      .page-layout.has-sidebar {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .has-sidebar .container {
        display: block;
        max-width: 700px;
      }

      .backup-sidebar {
        position: static;
        width: 100%;
        max-width: 700px;
        margin-bottom: 20px;
        order: -1;
      }
    }

    @media (max-width: 640px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="page-layout<%= ' has-sidebar' if @migration.backup_available? %>">
  <div class="container">
    <div class="header">
      <% if EuroskyConfig::LOGO_URL.present? %>
        <img src="<%= EuroskyConfig::LOGO_URL %>" alt="<%= EuroskyConfig::SITE_NAME %>" class="header-logo">
      <% end %>
      <h1>Migration Status</h1>
      <div class="token"><%= @migration.token %></div>
    </div>

    <div class="content">
      <% if flash[:notice] %>
        <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 16px; margin-bottom: 24px; border-radius: 4px; color: #065f46; font-size: 14px;">
          <%= flash[:notice] %>
        </div>
      <% end %>
      <% if flash[:alert] %>
        <div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 16px; margin-bottom: 24px; border-radius: 4px; color: #991b1b; font-size: 14px;">
          <%= flash[:alert] %>
        </div>
      <% end %>

      <div class="bookmark-notice" role="note">
        <h3>Bookmark This Page</h3>
        <p>Save this URL to track your migration progress:</p>
        <code><%= migration_by_token_url(@migration.token) %></code>
      </div>

      <div class="progress-section">
        <div class="progress-bar-container" role="progressbar" aria-valuenow="<%= @migration.progress_percentage %>" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-bar" style="width: <%= @migration.progress_percentage %>%">
            <%= @migration.progress_percentage %>%
          </div>
        </div>
      </div>

      <div class="status-info">
        <div class="status-label">Current Status</div>
        <div class="status-value status-<%= @migration.completed? ? 'completed' : @migration.failed? ? 'failed' : 'in-progress' %>">
          <%= @migration.status.humanize %>
          <% if @migration.job_retrying? && @migration.current_job_step %>
            <div style="font-size: 14px; color: #f59e0b; margin-top: 8px;">
              Retry <%= @migration.current_job_attempt %>/<%= @migration.current_job_max_attempts %> - <%= @migration.current_job_step.gsub('Job', '').humanize %>
            </div>
          <% end %>
        </div>
      </div>

      <% if @migration.progress_data&.dig('legacy_blob_conversion_started_at') && !@migration.progress_data&.dig('legacy_blob_conversion_completed_at') %>
        <div class="metric-card" style="margin-bottom: 24px; background: #fef3c7; border-color: #f59e0b;">
          <div class="metric-label" style="color: #92400e;">üîÑ Converting Legacy Blob Format</div>
          <p style="font-size: 14px; color: #92400e; margin-top: 8px;">
            Pre-2023 blob references are being converted to current format. This may take a few minutes...
          </p>
        </div>
      <% elsif @migration.progress_data&.dig('legacy_blobs_converted') == true %>
        <div class="metric-card" style="margin-bottom: 24px; background: #d1fae5; border-color: #10b981;">
          <div class="metric-label" style="color: #065f46;">‚úÖ Legacy Blobs Converted</div>
          <p style="font-size: 14px; color: #065f46; margin-top: 8px;">
            Legacy blob format has been successfully converted to current format.
          </p>
        </div>
      <% end %>

      <% if @migration.pending_blobs? %>
        <div class="metrics-grid">
          <% if @migration.progress_data['blobs'].present? %>
            <% blobs = @migration.progress_data['blobs'].values %>
            <% total_blobs = blobs.count %>
            <% total_size = blobs.sum { |b| b['size'].to_i } %>
            <% uploaded_size = blobs.sum { |b| b['uploaded'].to_i } %>

            <div class="metric-card">
              <div class="metric-label">Blobs Uploaded</div>
              <div class="metric-value">
                <%= total_blobs %>
                <span class="metric-unit">files</span>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Data Transferred</div>
              <div class="metric-value">
                <%= number_to_human_size(uploaded_size) %>
                <span class="metric-unit">/ <%= number_to_human_size(total_size) %></span>
              </div>
            </div>

            <% if @migration.estimated_time_remaining %>
              <div class="metric-card">
                <div class="metric-label">Time Remaining</div>
                <div class="metric-value">
                  <%= distance_of_time_in_words(@migration.estimated_time_remaining) %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <%# Backup Download Section %>
      <% if @migration.pending_download? || @migration.pending_backup? %>
        <div class="metric-card" style="margin-bottom: 24px; background: #dbeafe; border-color: #3b82f6;">
          <div class="metric-label" style="color: #1e40af;">
            <%= @migration.pending_download? ? 'üì• Downloading Account Data' : 'üì¶ Creating Backup Bundle' %>
          </div>
          <p style="font-size: 14px; color: #1e40af; margin-top: 8px;">
            <%= @migration.pending_download? ? 'Downloading your account data (repository + blobs) for backup and migration...' : 'Creating a downloadable backup bundle of your account data...' %>
          </p>
          <% if @migration.progress_data&.dig('download_progress') %>
            <% progress = @migration.progress_data['download_progress'] %>
            <p style="font-size: 14px; color: #1e40af; margin-top: 8px;">
              Downloaded: <%= progress['downloaded'] %> / <%= progress['total'] %> blobs
              <% if progress['bytes'] %>
                (<%= number_to_human_size(progress['bytes']) %>)
              <% end %>
            </p>
          <% end %>
        </div>
      <% end %>

      <% if @migration.backup_bundle_path.present? && @migration.backup_expired? %>
        <div class="metric-card" style="margin-bottom: 24px; background: #fee2e2; border-color: #dc2626;">
          <div class="metric-label" style="color: #991b1b;">‚ö†Ô∏è Backup Expired</div>
          <p style="font-size: 14px; color: #991b1b; margin-top: 8px;">
            Your backup bundle has expired and has been deleted from our servers.
          </p>
        </div>
      <% end %>

      <%# Rotation Key Section %>
      <% if @migration.rotation_key.present? && !@migration.pending_download? && !@migration.pending_backup? %>
        <div class="metric-card" style="margin-bottom: 24px; background: #fef3c7; border-color: #f59e0b;">
          <div class="metric-label" style="color: #92400e;">üîë Account Recovery Key</div>
          <p style="font-size: 14px; color: #92400e; margin-top: 8px; margin-bottom: 12px;">
            <strong>IMPORTANT:</strong> Save this rotation key in a secure location. It allows you to revert PLC changes or recover your account.
          </p>
          <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-family: monospace; font-size: 12px; overflow-wrap: break-word; word-break: break-all;">
            <%= @migration.rotation_key %>
          </div>
          <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã Copy to Clipboard', 2000)"
                  style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
            üìã Copy to Clipboard
          </button>
          <details style="margin-top: 16px;">
            <summary style="cursor: pointer; color: #92400e; font-weight: 600; font-size: 14px;">
              How to Use This Key to Revert Changes
            </summary>
            <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; font-size: 13px; color: #1f2937;">
              <p style="margin-bottom: 8px;">If you need to revert the PLC directory changes, you can use this rotation key:</p>
              <ol style="padding-left: 20px; margin: 8px 0;">
                <li style="margin-bottom: 6px;">Install the <code>goat</code> CLI tool</li>
                <li style="margin-bottom: 6px;">Get your PLC history: <code>goat plc history &lt;your-did&gt;</code></li>
                <li style="margin-bottom: 6px;">Identify the desired historical state (CID)</li>
                <li style="margin-bottom: 6px;">Create reversion operation: <code>goat plc update --prev &lt;cid&gt;</code></li>
                <li style="margin-bottom: 6px;">Sign with your rotation key: <code>goat plc sign</code></li>
                <li>Submit the signed operation: <code>goat plc submit --did &lt;your-did&gt;</code></li>
              </ol>
              <p style="margin-top: 8px; color: #dc2626;">
                <strong>Note:</strong> This is an advanced operation. Only use this if you understand the PLC directory system.
              </p>
            </div>
          </details>
        </div>
      <% end %>

      <% if @migration.pending_plc? %>
        <div class="plc-token-section" role="alert">
          <h3>Action Required: PLC Token</h3>

          <div class="warning">
            ‚ö†Ô∏è POINT OF NO RETURN - Once you submit the PLC token, your DID will be updated and this cannot be undone.
          </div>

          <p style="margin-bottom: 16px; color: #856404; font-size: 14px;">
            Your account data has been successfully migrated. Now you need to update your DID document to point to your new PDS.
          </p>

          <% unless @migration.has_old_pds_tokens? %>
            <%# Old PDS session expired ‚Äî offer re-authentication to request a new PLC token %>
            <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
              <h4 style="color: #1e40af; font-size: 15px; font-weight: 700; margin-bottom: 8px;">
                Need a PLC token? Re-authenticate to request one.
              </h4>
              <p style="color: #1e40af; font-size: 14px; margin-bottom: 12px;">
                Enter your password for <strong><%= @migration.old_handle %></strong> and we'll send you a new PLC token via email.
              </p>
              <form action="<%= reauthenticate_by_token_path(@migration.token) %>" method="post">
                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                <div style="margin-bottom: 12px;">
                  <input type="password" name="password" required
                         autocomplete="current-password"
                         placeholder="Password for <%= @migration.old_handle %>"
                         style="width: 100%; padding: 10px 12px; border: 2px solid #93c5fd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                </div>
                <button type="submit"
                        style="padding: 10px 20px; background: linear-gradient(135deg, <%= EuroskyConfig::PRIMARY_COLOR %> 0%, <%= EuroskyConfig::SECONDARY_COLOR %> 100%); color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 14px; cursor: pointer;">
                  Re-authenticate & Request PLC Token
                </button>
              </form>
            </div>
          <% end %>

          <p style="margin-bottom: 16px; color: #856404; font-size: 14px;">
            <% if @migration.has_old_pds_tokens? %>
              A PLC operation token has been requested from your old PDS provider (<strong><%= @migration.old_pds_host %></strong>).
              Check your email for the token, then enter it below.
            <% else %>
              Enter the PLC token you received via email below, or use the re-authentication form above to request a new one.
            <% end %>
          </p>

          <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
            <p style="margin: 0; color: #92400e; font-size: 13px;">
              ‚è∞ <strong>Important:</strong> PLC tokens expire after 1 hour. If your token has expired, you can request a new one.
            </p>
          </div>

          <%= form_with url: submit_plc_token_by_token_path(@migration.token), method: :post, local: true do |f| %>
            <div class="form-group">
              <%= label_tag :plc_token, "PLC Operation Token" %>
              <%= text_field_tag :plc_token, nil, required: true, placeholder: "Enter token from email", autocomplete: "off" %>
            </div>

            <%= submit_tag "Submit Token & Complete Migration", class: "submit-button", onclick: "return confirm('WARNING: This will permanently update your DID to point to the new PDS. This action CANNOT be undone. Are you absolutely sure you want to proceed?');" %>
          <% end %>
        </div>
      <% end %>

      <% if @migration.completed? %>
        <div class="success-message" role="alert">
          <h3 style="font-size: 24px; margin-bottom: 16px;">‚úÖ Migration Completed Successfully!</h3>
          <p style="font-size: 16px;">
            <% if @migration.returning_to_existing_pds? %>
              Your account has been successfully migrated back to <strong><%= @migration.new_pds_host %></strong>.
              You can now log in with your handle: <strong><%= @migration.new_handle %></strong>
            <% else %>
              Your account has been successfully migrated to <strong><%= @migration.new_pds_host %></strong>.
              You can now log in with your new handle: <strong><%= @migration.new_handle %></strong>
            <% end %>
          </p>

          <%# CRITICAL: Rotation Key Warning %>
          <% if @migration.rotation_key.present? %>
            <div style="background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; margin: 24px 0; border-radius: 6px;">
              <h4 style="color: #92400e; margin: 0 0 12px 0; font-size: 18px;">‚ö†Ô∏è SAVE YOUR ROTATION KEY NOW!</h4>
              <p style="color: #92400e; margin: 0 0 12px 0; font-size: 14px;">
                <strong>This page will be deleted in 10 minutes for your privacy.</strong><br>
                Your rotation key is needed for account recovery. Copy it now and store it securely!
              </p>
              <div style="background: white; padding: 12px; border-radius: 6px; margin: 12px 0; font-family: monospace; font-size: 12px; overflow-wrap: break-word; word-break: break-all;">
                <%= @migration.rotation_key %>
              </div>
              <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã Copy Rotation Key', 2000)"
                      style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; margin-bottom: 8px;">
                üìã Copy Rotation Key
              </button>
              <p style="font-size: 12px; color: #92400e; margin: 12px 0 0 0;">
                ‚úâÔ∏è We've also emailed this key to <strong><%= @migration.email %></strong>
              </p>
            </div>
          <% end %>

          <%# Auto-deletion warning %>
          <div style="background-color: #e0e7ff; border-left: 4px solid #6366f1; padding: 16px; margin: 16px 0; border-radius: 6px;">
            <h4 style="color: #3730a3; margin: 0 0 8px 0;">üîí Privacy Notice</h4>
            <p style="color: #3730a3; margin: 0; font-size: 14px;">
              For your privacy and GDPR compliance, this migration record will be automatically deleted in <strong>10 minutes</strong>.
              Make sure you've saved your rotation key and downloaded your backup before this page disappears!
            </p>
          </div>

          <p style="margin-top: 20px; font-size: 14px; color: #059669;">
            Your old account credentials have been securely deleted. Welcome <%= @migration.returning_to_existing_pds? ? 'back' : 'to your new home' %>!
          </p>
        </div>
      <% end %>

      <% if @migration.failed? %>
        <%= render 'migrations/error_details', migration: @migration %>
      <% end %>

      <% unless @migration.completed? || @migration.failed? %>
        <div class="auto-refresh-notice" role="status" aria-live="polite">
          This page will automatically refresh every 10 seconds to show the latest status.
        </div>
      <% end %>
    </div>
  </div>

  <% if @migration.backup_available? %>
    <div class="backup-sidebar">
      <div class="backup-sidebar-card<%= ' backup-urgent' if @migration.completed? %>">
        <div class="backup-sidebar-header">
          <%= @migration.completed? ? 'üì¶ Download Your Backup' : '‚úÖ Backup Ready' %>
        </div>
        <div class="backup-sidebar-body">
          <% if @migration.completed? %>
            <p>Your backup bundle will be deleted in <strong>10 minutes</strong>. Download it now!</p>
          <% else %>
            <p>Your account backup is ready! Download it before it expires.</p>
          <% end %>
          <div class="backup-meta">
            <strong>Size:</strong> <%= number_to_human_size(@migration.backup_size) %><br>
            <strong>Expires:</strong> <%= @migration.backup_expires_at.strftime('%b %d, %Y %l:%M %p') %>
          </div>
          <a href="<%= migration_download_backup_path(@migration, token: @migration.token) %>" class="backup-download-btn">
            ‚¨áÔ∏è Download Backup
          </a>
        </div>
      </div>
    </div>
  <% end %>

  </div>
</body>
</html>
