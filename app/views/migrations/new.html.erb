<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eurosky Migration - Start Account Migration</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: #1a1a1a;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.95;
    }

    .content {
      padding: 30px;
    }

    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 4px;
    }

    .warning-box h3 {
      color: #856404;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .warning-box ul {
      color: #856404;
      margin-left: 20px;
      font-size: 14px;
    }

    .warning-box li {
      margin-bottom: 4px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #333;
      font-size: 14px;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 15px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .helper-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }

    .security-note {
      background: #e0f2fe;
      border-left: 4px solid #0284c7;
      padding: 16px;
      margin: 24px 0;
      border-radius: 4px;
    }

    .security-note h3 {
      color: #075985;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .security-note p {
      color: #075985;
      font-size: 14px;
      line-height: 1.5;
    }

    .submit-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .submit-button:active {
      transform: translateY(0);
    }

    .submit-button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    .error-messages {
      background: #fee;
      border-left: 4px solid #dc2626;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 4px;
    }

    .error-messages h3 {
      color: #991b1b;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .error-messages ul {
      color: #991b1b;
      margin-left: 20px;
      font-size: 14px;
    }

    .error-messages li {
      margin-bottom: 4px;
    }

    @media (max-width: 640px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .content {
        padding: 20px;
      }
    }

    .field-error {
      border-color: #dc2626 !important;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
    }

    .error-message {
      color: #dc2626;
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }

    .error-message.visible {
      display: block;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('form');

      // Field definitions with validation rules
      const fields = {
        email: {
          element: document.getElementById('migration_email'),
          errorElement: document.getElementById('email-error'),
          validate: function(value) {
            if (!value || value.trim() === '') return 'Email address is required';
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) return 'Please enter a valid email address';
            return null;
          }
        },
        old_handle: {
          element: document.getElementById('migration_old_handle'),
          errorElement: document.getElementById('old-handle-error'),
          validate: function(value) {
            if (!value || value.trim() === '') return 'Old handle is required';
            if (!value.includes('.')) return 'Handle must include a domain (e.g., user.bsky.social)';
            return null;
          }
        },
        password: {
          element: document.getElementById('migration_password'),
          errorElement: document.getElementById('password-error'),
          validate: function(value) {
            if (!value || value.trim() === '') return 'Password is required';
            if (value.length < 8) return 'Password must be at least 8 characters';
            return null;
          }
        },
        new_pds_host: {
          element: document.getElementById('migration_new_pds_host'),
          errorElement: document.getElementById('new-pds-host-error'),
          validate: function(value) {
            if (!value || value.trim() === '') return 'New PDS host is required';
            // Accept both with and without https://
            const urlRegex = /^(https?:\/\/)?[\w.-]+\.[a-z]{2,}(\/.*)?$/i;
            if (!urlRegex.test(value)) return 'Please enter a valid PDS host (e.g., pds.example.com)';
            return null;
          }
        },
        new_handle: {
          element: document.getElementById('migration_new_handle'),
          errorElement: document.getElementById('new-handle-error'),
          validate: function(value) {
            if (!value || value.trim() === '') return 'New handle is required';
            if (!value.includes('.')) return 'Handle must include a domain (e.g., user.eurosky.social)';
            return null;
          }
        }
      };

      // Validate a single field
      function validateField(fieldName) {
        const field = fields[fieldName];
        if (!field || !field.element) return true;

        const value = field.element.value;
        const error = field.validate(value);

        if (error) {
          field.element.classList.add('field-error');
          if (field.errorElement) {
            field.errorElement.textContent = error;
            field.errorElement.classList.add('visible');
          }
          return false;
        } else {
          field.element.classList.remove('field-error');
          if (field.errorElement) {
            field.errorElement.classList.remove('visible');
          }
          return true;
        }
      }

      // Validate all fields
      function validateAllFields() {
        let isValid = true;
        Object.keys(fields).forEach(function(fieldName) {
          if (!validateField(fieldName)) {
            isValid = false;
          }
        });
        return isValid;
      }

      // Add real-time validation on blur
      Object.keys(fields).forEach(function(fieldName) {
        const field = fields[fieldName];
        if (field.element) {
          field.element.addEventListener('blur', function() {
            validateField(fieldName);
          });

          // Clear error on input
          field.element.addEventListener('input', function() {
            if (field.element.classList.contains('field-error')) {
              validateField(fieldName);
            }
          });
        }
      });

      // Form submission with validation
      form.addEventListener('submit', function(event) {
        event.preventDefault();

        // Validate all fields first
        if (!validateAllFields()) {
          // Scroll to first error
          const firstError = document.querySelector('.field-error');
          if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
          }
          return false;
        }

        // Show confirmation dialog only if validation passes
        const confirmed = confirm('Are you ready to start the migration? This process will begin immediately and cannot be stopped once started.');

        if (confirmed) {
          form.submit();
        }
      });
    });
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Eurosky Migration</h1>
      <p>Migrate your AT Protocol account to a new PDS</p>
    </div>

    <div class="content">
      <% if @migration&.errors&.any? %>
        <div class="error-messages" role="alert">
          <h3>Please correct the following errors:</h3>
          <ul>
            <% @migration.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="warning-box" role="alert">
        <h3>Important Information</h3>
        <ul>
          <li>This migration will take approximately 20-30 minutes</li>
          <li>Your account will be temporarily unavailable during migration</li>
          <li>You must have access to your old account's password</li>
          <li>You will need a PLC operation token from <a href="https://plc.directory" target="_blank" rel="noopener">plc.directory</a></li>
          <li>Make sure your new PDS is ready to accept your account</li>
        </ul>
      </div>

      <%= form_with model: @migration, url: migrations_path, local: true, html: { novalidate: true } do |f| %>
        <div class="form-group">
          <%= f.label :email, "Email Address" %>
          <%= f.email_field :email, id: "migration_email", placeholder: "you@example.com", autocomplete: "email" %>
          <div class="helper-text">We'll send migration status updates to this email</div>
          <div id="email-error" class="error-message"></div>
        </div>

        <div class="form-group">
          <%= f.label :old_handle, "Old Handle" %>
          <%= f.text_field :old_handle, id: "migration_old_handle", placeholder: "yourhandle.bsky.social", autocomplete: "username" %>
          <div class="helper-text">Your current AT Protocol handle (we'll automatically find your PDS)</div>
          <div id="old-handle-error" class="error-message"></div>
        </div>

        <div class="form-group">
          <%= f.label :password, "Account Password" %>
          <%= f.password_field :password, id: "migration_password", autocomplete: "current-password" %>
          <div class="helper-text">Your current account password for authentication</div>
          <div id="password-error" class="error-message"></div>
        </div>

        <div class="form-group">
          <%= f.label :new_pds_host, "New PDS Host" %>
          <%= f.text_field :new_pds_host, id: "migration_new_pds_host", placeholder: "pds.eurosky.social or https://pds.newhost.com", autocomplete: "url" %>
          <div class="helper-text">The hostname of your destination PDS (with or without https://)</div>
          <div id="new-pds-host-error" class="error-message"></div>
        </div>

        <div class="form-group">
          <%= f.label :new_handle, "New Handle" %>
          <%= f.text_field :new_handle, id: "migration_new_handle", placeholder: "yourhandle.eurosky.social", autocomplete: "username" %>
          <div class="helper-text">Your new AT Protocol handle on the destination PDS</div>
          <div id="new-handle-error" class="error-message"></div>
        </div>

        <div class="security-note" role="note">
          <h3>Security & Privacy</h3>
          <p>
            Your password is encrypted and stored securely for 48 hours, then automatically deleted.
            It is only used to authenticate with your old PDS during migration.
            We never store or transmit your password in plaintext.
          </p>
        </div>

        <%= f.submit "Start Migration", class: "submit-button" %>
      <% end %>
    </div>
  </div>
</body>
</html>
